<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bin Packing Visualization</title>
    <style>
        .bin-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        canvas { border: 1px solid black; }
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 5px; }
        input { width: 80px; }
        .quantity-input { width: 60px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .bin-card { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; background-color: #f9f9f9; }
        .remainder-material { background-color: #e8f5e8; border-color: #4caf50; border-width: 2px; }
        .new-material { background-color: #e3f2fd; border-color: #2196f3; }
        .bin-title { margin: 0 0 10px 0; color: #333; }
        .bin-subtitle { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .new-material-settings { background-color: #fff3e0; border: 1px solid #ff9800; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
<h1>Cutting Optimizer Visualization</h1>

<!-- æ·»åŠ é¡¹ç›® -->
<div class="section">
    <h3>æ·»åŠ åˆ‡å‰²é¡¹ç›®</h3>
    <input type="text" id="label" placeholder="æ ‡ç­¾">
    <input type="number" id="width" placeholder="å®½(cm)" step="0.1" min="0.1">
    <input type="number" id="height" placeholder="é«˜(cm)" step="0.1" min="0.1">
    <input type="number" id="quantity" placeholder="æ•°é‡" class="quantity-input" value="1" min="1">
    <button onclick="addItem()">æ·»åŠ é¡¹ç›®</button>
</div>

<!-- æ·»åŠ å‰©ä½™ææ–™ -->
<div class="section">
    <h3>æ·»åŠ å‰©ä½™ææ–™</h3>
    <input type="text" id="materialName" placeholder="ææ–™åç§°">
    <input type="number" id="materialWidth" placeholder="å®½(cm)" step="0.1" min="0.1">
    <input type="number" id="materialHeight" placeholder="é«˜(cm)" step="0.1" min="0.1">
    <input type="number" id="materialCount" placeholder="æ•°é‡" class="quantity-input" value="1" min="1">
    <button onclick="addMaterial()">æ·»åŠ ææ–™</button>
</div>

<!-- æ“ä½œæŒ‰é’® -->
<div>
    <button onclick="runOptimization()">å¼€å§‹ä¼˜åŒ–</button>
    <button onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
</div>

<!-- é¡¹ç›®åˆ—è¡¨ -->
<h3>åˆ‡å‰²é¡¹ç›®</h3>
<table id="itemTable">
    <thead>
    <tr>
        <th>Label</th>
        <th>Width (cm)</th>
        <th>Height (cm)</th>
        <th>æ•°é‡</th>
        <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- å‰©ä½™ææ–™åˆ—è¡¨ -->
<h3>å‰©ä½™ææ–™</h3>
<table id="materialTable">
    <thead>
    <tr>
        <th>åç§°</th>
        <th>Width (cm)</th>
        <th>Height (cm)</th>
        <th>æ•°é‡</th>
        <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div id="stats"></div>

<!-- ç»“æœç”»å¸ƒ -->
<div id="bins" class="bin-container"></div>

<script>
    let items = [];
    let materials = [];


    function addItem() {
        const label = document.getElementById('label').value.trim();
        const width = parseFloat(document.getElementById('width').value);
        const height = parseFloat(document.getElementById('height').value);
        const quantity = parseInt(document.getElementById('quantity').value);

        if (!label || isNaN(width) || isNaN(height) || isNaN(quantity) ||
            width <= 0 || height <= 0 || quantity <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡¹ç›®å‚æ•°ï¼");
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡ç­¾çš„é¡¹ç›®
        const existingIndex = items.findIndex(item => item.label === label);
        if (existingIndex !== -1) {
            items[existingIndex].quantity = quantity;
        } else {
            items.push({label, width, height, quantity});
        }

        renderItemTable();
        updateStats();
        clearItemInputs();
    }

    function addMaterial() {
        const name = document.getElementById('materialName').value.trim();
        const width = parseFloat(document.getElementById('materialWidth').value);
        const height = parseFloat(document.getElementById('materialHeight').value);
        const count = parseInt(document.getElementById('materialCount').value);

        if (!name || isNaN(width) || isNaN(height) || isNaN(count) ||
            width <= 0 || height <= 0 || count <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ææ–™å‚æ•°ï¼");
            return;
        }

        materials.push({name, width, height, count});
        renderMaterialTable();
        updateStats();
        clearMaterialInputs();
    }

    function removeItem(index) {
        items.splice(index, 1);
        renderItemTable();
        updateStats();
    }

    function removeMaterial(index) {
        materials.splice(index, 1);
        renderMaterialTable();
        updateStats();
    }

    function clearAll() {
        items = [];
        materials = [];
        renderItemTable();
        renderMaterialTable();
        updateStats();
        document.getElementById('bins').innerHTML = '';
    }

    function clearItemInputs() {
        document.getElementById('label').value = '';
        document.getElementById('width').value = '';
        document.getElementById('height').value = '';
        document.getElementById('quantity').value = '1';
        document.getElementById('label').focus();
    }

    function clearMaterialInputs() {
        document.getElementById('materialName').value = '';
        document.getElementById('materialWidth').value = '';
        document.getElementById('materialHeight').value = '';
        document.getElementById('materialCount').value = '1';
        document.getElementById('materialName').focus();
    }

    function renderItemTable() {
        const tbody = document.querySelector('#itemTable tbody');
        tbody.innerHTML = '';
        items.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.label}</td>
                <td>${item.width.toFixed(1)}</td>
                <td>${item.height.toFixed(1)}</td>
                <td>${item.quantity}</td>
                <td><button onclick="removeItem(${index})">åˆ é™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderMaterialTable() {
        const tbody = document.querySelector('#materialTable tbody');
        tbody.innerHTML = '';
        materials.forEach((material, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${material.name}</td>
                <td>${material.width.toFixed(1)}</td>
                <td>${material.height.toFixed(1)}</td>
                <td>${material.count}</td>
                <td><button onclick="removeMaterial(${index})">åˆ é™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateStats() {
        const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
        const totalMaterials = materials.reduce((sum, material) => sum + material.count, 0);
        const totalItemArea = items.reduce((sum, item) => sum + (item.width * item.height * item.quantity), 0);

        document.getElementById('stats').innerHTML =
            `<p>æ€»é¡¹ç›®æ•°: ${totalItems} (é¢ç§¯: ${totalItemArea.toFixed(1)} cmÂ²), å‰©ä½™ææ–™: ${totalMaterials} ç§</p>`;
    }

    async function runOptimization() {
        if (items.length === 0) {
            alert("è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªåˆ‡å‰²é¡¹ç›®ï¼");
            return;
        }

        // å±•å¼€æ•°é‡ï¼šå°†æ¯ä¸ªé¡¹ç›®æ ¹æ®æ•°é‡ç”Ÿæˆå¤šä¸ªå®ä¾‹
        const expandedItems = [];
        items.forEach(item => {
            for (let i = 0; i < item.quantity; i++) {
                expandedItems.push({
                    label: `${item.label}_${i + 1}`,
                    width: item.width,
                    height: item.height
                });
            }
        });

        // å‡†å¤‡ææ–™æ•°æ®ï¼ˆä¿æŒå˜ç±³å•ä½å‘é€ç»™åç«¯ï¼‰
        const materialData = materials.map(material => ({
            name: material.name,
            width: material.width / 100, // è½¬æ¢ä¸ºç±³
            height: material.height / 100, // è½¬æ¢ä¸ºç±³
            availableCount: material.count
        }));


        // åˆå¹¶ç°æœ‰ææ–™å’Œæ–°æ¿æ
        const allMaterialsForAPI = [...materialData];

        console.log("å‘é€åˆ°APIçš„æ•°æ®:", {
            items: expandedItems.map(i => ({
                label: i.label,
                width: i.width / 100, // è½¬æ¢ä¸ºç±³
                height: i.height / 100 // è½¬æ¢ä¸ºç±³
            })),
            materials: allMaterialsForAPI  // åŒ…å«äº†æ–°æ¿æè®¾ç½®ï¼
        });

        // API æ¥å£æ˜¯ç±³ï¼Œè¿™é‡Œå˜ç±³ â†’ ç±³
        const payload = {
            items: expandedItems.map(i => ({
                label: i.label,
                width: +(i.width / 100).toFixed(4),
                height: +(i.height / 100).toFixed(4)
            })),
            materials: allMaterialsForAPI  // çœŸæ­£ä¼ é€’åŒ…å«æ–°æ¿æçš„æ‰€æœ‰ææ–™ï¼
        };

        try {
            const response = await fetch("/api/optimize-with-materials", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(response.statusText);
            }

            const results = await response.json();
            console.log("APIè¿”å›ç»“æœ:", results);

            // è®¡ç®—æ€»é¡¹ç›®æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const totalOriginalItems = items.reduce((sum, item) => sum + item.quantity, 0);
            drawBins(results, totalOriginalItems);
        } catch (error) {
            alert("API è°ƒç”¨å¤±è´¥: " + error.message);
        }
    }

    function drawBins(results, totalItems) {
        const container = document.getElementById('bins');
        container.innerHTML = "";

        // æ”¶é›†ç”¨æˆ·å®šä¹‰çš„ææ–™åç§°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºæ—§ææ–™
        const userMaterialNames = new Set(materials.map(m => m.name));

        // æ‰¾åˆ°æ‰€æœ‰ææ–™ä¸­çš„æœ€å¤§å°ºå¯¸ï¼Œç”¨äºç»Ÿä¸€ç¼©æ”¾
        let maxMaterialWidth = 0;
        let maxMaterialHeight = 0;
        results.forEach(bin => {
            if (bin.materialWidth > maxMaterialWidth) maxMaterialWidth = bin.materialWidth;
            if (bin.materialHeight > maxMaterialHeight) maxMaterialHeight = bin.materialHeight;
        });

        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆåŸºäºæœ€å¤§ææ–™å°ºå¯¸ï¼‰
        const maxCanvasSize = 400;
        const scale = Math.min(
            maxCanvasSize / (maxMaterialWidth * 100),
            maxCanvasSize / (maxMaterialHeight * 100)
        ) * 100;

        // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
        const totalMaterialsUsed = results.length;
        const summary = document.createElement('div');
        summary.innerHTML = `
            <h3>ä¼˜åŒ–ç»“æœ: ä½¿ç”¨ ${totalMaterialsUsed} å—ææ–™, æ”¾ç½® ${totalItems} ä¸ªé¡¹ç›®</h3>
        `;
        container.appendChild(summary);

        results.forEach((bin, index) => {
            const binCard = document.createElement('div');
            binCard.className = 'bin-card';

            // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·æä¾›çš„æ—§ææ–™
            let isRemainderMaterial = false;
            if (bin.materialType) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å®šä¹‰çš„ææ–™åç§°
                isRemainderMaterial = userMaterialNames.has(bin.materialType) ||
                    Array.from(userMaterialNames).some(name => bin.materialType.startsWith(name + '_'));
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯æ–°æ¿æåˆ™ä¸æ˜¯æ—§ææ–™
                if (bin.materialType.includes('æ–°')) {
                    isRemainderMaterial = false;
                }
            }

            if (isRemainderMaterial) {
                binCard.classList.add('remainder-material');
            } else {
                binCard.classList.add('new-material');
            }

            // ä½¿ç”¨å˜ç±³æ˜¾ç¤ºå°ºå¯¸
            const displayWidth = (bin.materialWidth * 100).toFixed(1);
            const displayHeight = (bin.materialHeight * 100).toFixed(1);

            const title = document.createElement('h3');
            title.className = 'bin-title';
            title.textContent = bin.materialType || 'ææ–™';

            const subtitle = document.createElement('p');
            subtitle.className = 'bin-subtitle';
            subtitle.innerHTML = `
                ID: ${bin.binId} |
                å°ºå¯¸: ${displayWidth}Ã—${displayHeight}cm |
                åˆ©ç”¨ç‡: ${bin.utilization.toFixed(1)}%
                ${isRemainderMaterial ? ' â™»ï¸ å‰©ä½™ææ–™' : ' ğŸ†• æ–°ææ–™'}
            `;

            binCard.appendChild(title);
            binCard.appendChild(subtitle);

            const canvas = document.createElement('canvas');
            // ä½¿ç”¨å®é™…ææ–™å°ºå¯¸è®¡ç®—ç”»å¸ƒå¤§å°
            const binWidthCm = bin.materialWidth * 100;
            const binHeightCm = bin.materialHeight * 100;
            const canvasWidth = Math.max(200, binWidthCm * scale / 100);
            const canvasHeight = Math.max(200, binHeightCm * scale / 100);
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext('2d');

            // ç»˜åˆ¶ææ–™èƒŒæ™¯
            ctx.fillStyle = isRemainderMaterial ? '#e8f5e8' : '#e3f2fd';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ææ–™è¾¹ç•Œï¼ˆä½¿ç”¨å®é™…å°ºå¯¸ï¼‰
            const binWidthPx = binWidthCm * scale / 100;
            const binHeightPx = binHeightCm * scale / 100;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, binWidthPx, binHeightPx);

            // ç»˜åˆ¶ç½‘æ ¼çº¿ï¼ˆæ¯10å˜ç±³ï¼‰
            ctx.strokeStyle = '#bbb';
            ctx.lineWidth = 1;
            const gridSpacingCm = 10;

            // å‚ç›´ç½‘æ ¼çº¿
            for (let i = 0; i <= Math.ceil(binWidthCm / gridSpacingCm); i++) {
                const x = i * gridSpacingCm * scale / 100;
                if (x <= binWidthPx) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, binHeightPx);
                    ctx.stroke();
                }
            }

            // æ°´å¹³ç½‘æ ¼çº¿
            for (let i = 0; i <= Math.ceil(binHeightCm / gridSpacingCm); i++) {
                const y = i * gridSpacingCm * scale / 100;
                if (y <= binHeightPx) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(binWidthPx, y);
                    ctx.stroke();
                }
            }

            // ç»˜åˆ¶æ¯ä¸ªpieceï¼ˆä½¿ç”¨å˜ç±³å•ä½ï¼‰
            bin.pieces.forEach(piece => {
                const hue = Math.floor(Math.random() * 360);
                const color = `hsl(${hue}, 70%, 80%)`;

                // ä½¿ç”¨å˜ç±³å•ä½ç»˜åˆ¶
                const x = Math.round((piece.x * 100) * scale / 100);
                const y = Math.round((piece.y * 100) * scale / 100);
                const w = Math.round((piece.w * 100) * scale / 100);
                const h = Math.round((piece.h * 100) * scale / 100);

                // ç»˜åˆ¶å¡«å……
                ctx.fillStyle = color;
                ctx.fillRect(x, y, w, h);

                // ç»˜åˆ¶è¾¹æ¡†
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, w, h);

                // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                const labelWidth = Math.min(w - 4, 120);
                ctx.fillRect(x + 2, y + 2, labelWidth, 36);

                // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(piece.label, x + 6, y + 16);

                // æ˜¾ç¤ºå°ºå¯¸ï¼ˆä½¿ç”¨å˜ç±³ï¼‰
                ctx.fillStyle = 'white';
                ctx.font = '11px Arial';
                const sizeText = `${(piece.w * 100).toFixed(1)}Ã—${(piece.h * 100).toFixed(1)}cm`;
                ctx.fillText(sizeText, x + 6, y + 30);
            });

            binCard.appendChild(canvas);
            container.appendChild(binCard);
        });
    }

    // å›è½¦é”®æ·»åŠ é¡¹ç›®
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            if (document.activeElement.id === 'label' ||
                document.activeElement.id === 'width' ||
                document.activeElement.id === 'height' ||
                document.activeElement.id === 'quantity') {
                addItem();
            } else if (document.activeElement.id === 'materialName' ||
                document.activeElement.id === 'materialWidth' ||
                document.activeElement.id === 'materialHeight' ||
                document.activeElement.id === 'materialCount') {
                addMaterial();
            }
        }
    });

    // é¡µé¢åŠ è½½æ—¶èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
    window.addEventListener('load', function() {
        document.getElementById('label').focus();
    });
</script>
</body>
</html>